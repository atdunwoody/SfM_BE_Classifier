## SfM_BE_Classifier
Random forest classification of bare earth and vegetation for raster files too large for memory. This workflow was made for drone based Structure from Motion (SfM)  datasets, which typically produce very fine resolution rasters. These rasters often have a resolution of less than 10 centimeters, so watershed-sized survey areas result in rasters that are too large to fit in memory. 

This workflow leverages the fine resolution elevation and RGB data provided by SfM processing to classify bare earth pixels for elevation change detection studies. The code was tested on a dataset of mountainous, wildfire burned watershed with an orthomosaic resolution of 1.8 cm amd a DEM Resolution of 3.6 cm.  

Inputs:
 - Orthomosaic (red, green, and blue bands)
 - DEM
 - Training and Validation shapefiles  

Open `RF_input_parameters.py` and update the file_paths 
Open `RF_driver.ipynb` and run all cells 

Creating training and validation shapefiles:
 - Use nonzero integers to identify classification categories. Zero is the nodata value.
 - Balance the classes in your training shapefile. If there is significantly more pixels of one class in your training data than another (e.g. 10X more vegetation pixels than bare earth) the model may be biased torwards misclassifying bare earth pixels as vegetation.
 - Beware of data leakage. Make sure training and validation shapefiles do not overlap. Additionally, if you run your model multiple times and change the training data or hyperparameters between each run to try to improve performance on the validation data, the model may "learn" to perform on that specific validation set. It is good practice to have a subset of your validation data thatthe final trained model only sees once.


# Installation
Clone this GitHub repository, or download the entire repository to your local machine. Do not move any of the files within the repository, as this may cause the workflow to break.
Create a virtual environment called `SfM_RF` in miniconda3 by opening the Anaconda Prompt and installing the `environment_PC.yml` file:

`conda env create -n SfM_classifier -f environment_PC.yml`\n
`conda activate SfM_classifier`

# Example Outputs

Below are examples of input orthomosaic images and their corresponding output classified images generated by the SfM_BE_Classifier workflow.

**Input Orthomosaic:**

![Ortho Image 1](Images/Ortho_Image%201.png "Ortho Image 1")

**Output Classified Image:**

![Classified Image 1](Images/Classified_Image%201.png "Classified Image 1")

**Input Orthomosaic:**

![Ortho Image 2](Images/Ortho_Image%202.png "Ortho Image 2")

**Output Classified Image:**

![Classified Image 2](Images/Classified_Image%202.png "Classified Image 2")



# QGIS Post-Processing
Performance is improved by "sieving" the final output classified raster to remove very small patches of possibly misclassified pixels. The idea behind this step is that patches of bare earth that are less than a few dozen square centimeters are likely artifacts of the classification process and should be reclassified as the dominant surrounding class. 

This step is currently most easily performed in the SCP Plugin for QGIS. 

# Acknowledgements
This workflow is based on work from Florian Beyer and Chris Holden (Beyer et al., 2019). 

